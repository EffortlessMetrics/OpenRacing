# cargo-deny configuration for OpenRacing dependency auditing.
# Covers license compliance, security advisories, crate bans, and source provenance.
# See: https://embarkstudios.github.io/cargo-deny/

# =============================================================================
# License checks
# =============================================================================
[licenses]
# Permissive and weak-copyleft licenses only.
# Any license not listed here is automatically rejected.
# GPL/LGPL/AGPL are denied by omission — do NOT add them.
allow = [
    "MIT",
    "MIT-0",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "CC0-1.0",
    "Zlib",
    "Unicode-3.0",
    "Unicode-DFS-2016",
    # MPL-2.0 is a weak (file-level) copyleft compatible with permissive
    # licenses (Section 3.3). Used by: colored, bitmaps, im-rc, etc.
    "MPL-2.0",
    # CDLA-Permissive-2.0 is a permissive data license.
    # Used by: foldhash, webpki-roots.
    "CDLA-Permissive-2.0",
]

# Confidence threshold for license text detection (0.0–1.0).
# 0.8 = require 80% confidence before accepting a detected license.
confidence-threshold = 0.8

# Per-crate license exceptions — keeps the global allowlist tight.
# Only grant unusual licenses to the specific crates that need them.
exceptions = [
    # ring uses "MIT AND ISC AND OpenSSL"; MIT and ISC are allowed globally.
    { allow = ["OpenSSL"], name = "ring", version = "*" },
    # ppmd-rust uses the bzip2 license (permissive, BSD-like).
    { allow = ["bzip2-1.0.6"], name = "ppmd-rust", version = "*" },
]

# =============================================================================
# Crate bans — block specific crates or versions
# =============================================================================
[bans]
# Warn (not deny) on duplicate crate versions to avoid blocking builds while
# still surfacing technical debt.
multiple-versions = "warn"

# Wildcard version requirements ("*") are a supply-chain risk; warn on them.
# Workspace path dependencies commonly use wildcards, which is expected.
wildcards = "warn"
allow-wildcard-paths = true

# Graph highlighting for dotgraph output when duplicate versions are found.
highlight = "all"

# List of crates that are allowed. Use with care — an empty list means all
# crates are allowed (subject to the deny list below).
allow = []

# Deny old versions of crates with known security vulnerabilities.
deny = [
    { name = "openssl", version = "<0.10.55" },
    { name = "openssl-sys", version = "<0.9.87" },
]

# Crate versions skipped during duplicate detection.
skip = []

# Like `skip`, but also skips the crate's entire dependency subtree.
skip-tree = []

# =============================================================================
# Security advisories (RustSec)
# =============================================================================
[advisories]
# Advisory database location and source.
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]

# NOTE: As of cargo-deny 0.14+, `vulnerability`, `unsound`, and `notice`
# fields are removed — all matching advisories now always produce errors.
# Only `unmaintained` and `yanked` remain configurable.

# Unmaintained crate handling:
#   "all"       — error on any unmaintained crate
#   "workspace" — error only for direct workspace dependencies
#   "none"      — ignore unmaintained advisories entirely
# We use "workspace" to flag direct dependencies we control while avoiding
# noise from deep transitive crates we cannot easily replace.
unmaintained = "workspace"

# Yanked crate versions: warn so CI doesn't hard-fail, but developers see it.
yanked = "warn"

# Advisory IDs to ignore. Each entry should include a reason comment above it.
# Example:
#   # RUSTSEC-2024-XXXX — does not affect our usage (no TLS client code)
#   "RUSTSEC-2024-XXXX",
ignore = []

# =============================================================================
# Source provenance — restrict where crates may come from
# =============================================================================
[sources]
# Crates from unknown registries or git repos should produce warnings so we
# catch unexpected sources without hard-failing builds.
unknown-registry = "warn"
unknown-git = "warn"

# Only crates.io is allowed as a registry source.
allow-registry = ["https://github.com/rust-lang/crates.io-index"]

# No git sources are pre-approved; add URLs here if needed.
allow-git = []