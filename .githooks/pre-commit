#!/usr/bin/env bash
# .githooks/pre-commit
# Runs fast local checks before every commit.
# Install once per clone:
#   git config core.hooksPath .githooks

set -euo pipefail

# --------------------------------------------------------------------------- #
# 1. workspace-hack drift check (cargo hakari)                                #
# --------------------------------------------------------------------------- #
if command -v cargo-hakari &>/dev/null; then
    echo "[pre-commit] Checking workspace-hack..."
    if ! cargo hakari verify 2>/dev/null; then
        echo ""
        echo "ERROR: workspace-hack is out of date."
        echo "  Run:  cargo hakari generate"
        echo "  Then: git add workspace-hack/ && git commit --amend --no-edit"
        exit 1
    fi
else
    echo "[pre-commit] cargo-hakari not installed, skipping workspace-hack check."
    echo "  Install with:  cargo install cargo-hakari"
fi

# --------------------------------------------------------------------------- #
# 2. YAML sync check (game_support_matrix must be identical in both crates)   #
# --------------------------------------------------------------------------- #
if command -v python3 &>/dev/null; then
    REPO_ROOT="$(git rev-parse --show-toplevel)"
    YAML_A="$REPO_ROOT/crates/telemetry-config/src/game_support_matrix.yaml"
    YAML_B="$REPO_ROOT/crates/telemetry-support/src/game_support_matrix.yaml"
    if [[ -f "$YAML_A" && -f "$YAML_B" ]]; then
        if ! diff -q "$YAML_A" "$YAML_B" >/dev/null 2>&1; then
            echo ""
            echo "ERROR: game_support_matrix.yaml files are out of sync."
            echo "  Run:  python scripts/sync_yaml.py"
            echo "  Then: git add $YAML_A $YAML_B"
            exit 1
        fi
    fi
fi

echo "[pre-commit] OK"
exit 0
