name: Compatibility Layer Usage Tracking

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  track-compat-usage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch full history for comparison
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Track current compat usage
      run: |
        python scripts/track_compat_usage.py
        echo "CURRENT_USAGE=$(python scripts/track_compat_usage.py | grep 'usage count:' | cut -d' ' -f4)" >> $GITHUB_ENV
    
    - name: Get baseline usage count (main branch)
      if: github.event_name == 'pull_request'
      run: |
        git checkout origin/main
        python scripts/track_compat_usage.py > baseline_report.txt
        BASELINE_USAGE=$(grep 'usage count:' baseline_report.txt | cut -d' ' -f4)
        echo "BASELINE_USAGE=$BASELINE_USAGE" >> $GITHUB_ENV
        git checkout ${{ github.sha }}
    
    - name: Check usage trend
      if: github.event_name == 'pull_request'
      run: |
        echo "Current usage: $CURRENT_USAGE"
        echo "Baseline usage: $BASELINE_USAGE"
        
        if [ "$CURRENT_USAGE" -gt "$BASELINE_USAGE" ]; then
          echo "‚ùå Compatibility layer usage increased from $BASELINE_USAGE to $CURRENT_USAGE"
          echo "This violates the policy that compat usage should trend downward."
          echo "Please migrate the new usage to use new field names instead of the compat layer."
          exit 1
        elif [ "$CURRENT_USAGE" -lt "$BASELINE_USAGE" ]; then
          echo "‚úÖ Compatibility layer usage decreased from $BASELINE_USAGE to $CURRENT_USAGE"
          echo "Great job migrating away from the compat layer!"
        else
          echo "‚ÑπÔ∏è Compatibility layer usage unchanged at $CURRENT_USAGE"
        fi
    
    - name: Upload compat usage report
      uses: actions/upload-artifact@v4
      with:
        name: compat-usage-report
        path: compat_usage_report.json
        retention-days: 30
    
    - name: Store usage metrics for trending
      run: |
        # Store metrics with timestamp for trending analysis
        echo "{\"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"usage_count\": $CURRENT_USAGE, \"commit\": \"${{ github.sha }}\", \"branch\": \"${{ github.ref_name }}\"}" >> usage_metrics.jsonl
    
    - name: Upload usage metrics
      uses: actions/upload-artifact@v4
      with:
        name: usage-metrics-${{ github.run_id }}
        path: usage_metrics.jsonl
        retention-days: 90
    
    - name: Analyze usage trend
      if: github.event_name == 'pull_request'
      run: |
        # Download recent metrics for trend analysis
        python scripts/analyze_compat_trend.py --current $CURRENT_USAGE --baseline $BASELINE_USAGE
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('compat_usage_report.json', 'utf8'));
          
          let comment = `## Compatibility Layer Usage Report\n\n`;
          comment += `**Current usage count:** ${report.usage_count}\n`;
          comment += `**Baseline usage count:** ${process.env.BASELINE_USAGE}\n`;
          
          const change = report.usage_count - parseInt(process.env.BASELINE_USAGE);
          if (change > 0) {
            comment += `‚ùå **Usage increased by ${change}** - Please migrate new usage to use new field names.\n\n`;
            comment += `### üö® Policy Violation\n`;
            comment += `This PR increases compatibility layer usage, which violates our [Schema Governance Policy](../docs/SCHEMA_GOVERNANCE.md).\n`;
            comment += `Please update the new code to use the new field names instead of the compatibility layer.\n\n`;
          } else if (change < 0) {
            comment += `‚úÖ **Usage decreased by ${Math.abs(change)}** - Great job migrating away from the compat layer!\n\n`;
            comment += `### üéâ Migration Progress\n`;
            comment += `This PR helps us move toward removing the compatibility layer. Thank you for the migration effort!\n\n`;
          } else {
            comment += `‚ÑπÔ∏è **Usage unchanged**\n\n`;
          }
          
          // Add trend analysis if available
          if (fs.existsSync('trend_analysis.json')) {
            const trend = JSON.parse(fs.readFileSync('trend_analysis.json', 'utf8'));
            comment += `### üìà Usage Trend (Last 30 Days)\n\n`;
            comment += `- **Peak usage:** ${trend.peak_usage}\n`;
            comment += `- **Current trend:** ${trend.trend_direction} (${trend.trend_percentage}%)\n`;
            comment += `- **Projected removal:** ${trend.projected_removal_date}\n\n`;
          }
          
          if (report.usage_details.length > 0) {
            comment += `### Usage Details\n\n`;
            for (const detail of report.usage_details.slice(0, 10)) {
              comment += `- \`${detail.file}:${detail.line}\` - \`${detail.method}\`\n`;
            }
            if (report.usage_details.length > 10) {
              comment += `\n... and ${report.usage_details.length - 10} more occurrences\n`;
            }
            
            comment += `\n### Migration Guide\n\n`;
            comment += `To migrate these usages, replace:\n`;
            comment += `- \`.temp_c()\` ‚Üí \`.temperature_c\`\n`;
            comment += `- \`.faults()\` ‚Üí \`.fault_flags\`\n`;
            comment += `- \`.wheel_angle_mdeg()\` ‚Üí \`.wheel_angle_deg\`\n`;
            comment += `- \`.wheel_speed_mrad_s()\` ‚Üí \`.wheel_speed_rad_s\`\n\n`;
            comment += `See [Migration Patterns](../docs/MIGRATION_PATTERNS.md) for detailed examples.\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });