name: Compatibility Layer Usage Tracking

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  track-compat-usage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch full history for comparison
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install ripgrep
      run: sudo apt-get install -y ripgrep
    
    - name: Track current compat usage
      run: |
        python scripts/track_compat_usage.py --current
        # Read total from the JSON file saved by --current
        CURRENT_USAGE=$(python -c "import json; d=json.load(open('compat_current.json')); print(d.get('total_usages', 0))")
        echo "CURRENT_USAGE=$CURRENT_USAGE" >> $GITHUB_ENV
    
    - name: Get baseline usage count (main branch)
      if: github.event_name == 'pull_request'
      run: |
        git checkout origin/main
        python scripts/track_compat_usage.py --current
        BASELINE_USAGE=$(python -c "import json; d=json.load(open('compat_current.json')); print(d.get('total_usages', 0))")
        echo "BASELINE_USAGE=$BASELINE_USAGE" >> $GITHUB_ENV
        git checkout ${{ github.sha }}
    
    - name: Check usage trend
      if: github.event_name == 'pull_request'
      run: |
        CURRENT=${CURRENT_USAGE:-0}
        BASELINE=${BASELINE_USAGE:-0}
        echo "Current usage: $CURRENT"
        echo "Baseline usage: $BASELINE"
        
        if [ "$CURRENT" -gt "$BASELINE" ]; then
          echo "‚ùå Compatibility layer usage increased from $BASELINE to $CURRENT"
          echo "This violates the policy that compat usage should trend downward."
          echo "Please migrate the new usage to use new field names instead of the compat layer."
          exit 1
        elif [ "$CURRENT" -lt "$BASELINE" ]; then
          echo "‚úÖ Compatibility layer usage decreased from $BASELINE to $CURRENT"
          echo "Great job migrating away from the compat layer!"
        else
          echo "‚ÑπÔ∏è Compatibility layer usage unchanged at $CURRENT"
        fi
    
    - name: Upload compat usage report
      uses: actions/upload-artifact@v4
      with:
        name: compat-usage-report
        path: compat_current.json
        retention-days: 30
    
    - name: Store usage metrics for trending
      run: |
        # Store metrics with timestamp for trending analysis
        USAGE=${CURRENT_USAGE:-0}
        echo "{\"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"usage_count\": $USAGE, \"commit\": \"${{ github.sha }}\", \"branch\": \"${{ github.ref_name }}\"}" >> usage_metrics.jsonl
    
    - name: Upload usage metrics
      uses: actions/upload-artifact@v4
      with:
        name: usage-metrics-${{ github.run_id }}
        path: usage_metrics.jsonl
        retention-days: 90
    
    - name: Analyze usage trend
      if: github.event_name == 'pull_request'
      run: |
        # Download recent metrics for trend analysis
        CURRENT=${CURRENT_USAGE:-0}
        BASELINE=${BASELINE_USAGE:-0}
        python scripts/analyze_compat_trend.py --current $CURRENT --baseline $BASELINE
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          // compat_current.json is written by track_compat_usage.py --current
          // format: { total_usages: N, by_pattern: {...}, ... }
          const report = JSON.parse(fs.readFileSync('compat_current.json', 'utf8'));
          const currentCount = report.total_usages || 0;
          const baselineCount = parseInt(process.env.BASELINE_USAGE || '0', 10);
          
          let comment = `## Compatibility Layer Usage Report\n\n`;
          comment += `**Current usage count:** ${currentCount}\n`;
          comment += `**Baseline usage count:** ${baselineCount}\n`;
          
          const change = currentCount - baselineCount;
          if (change > 0) {
            comment += `‚ùå **Usage increased by ${change}** - Please migrate new usage to use new field names.\n\n`;
            comment += `### üö® Policy Violation\n`;
            comment += `This PR increases compatibility layer usage, which violates our [Schema Governance Policy](../docs/SCHEMA_GOVERNANCE.md).\n`;
            comment += `Please update the new code to use the new field names instead of the compatibility layer.\n\n`;
          } else if (change < 0) {
            comment += `‚úÖ **Usage decreased by ${Math.abs(change)}** - Great job migrating away from the compat layer!\n\n`;
            comment += `### üéâ Migration Progress\n`;
            comment += `This PR helps us move toward removing the compatibility layer. Thank you for the migration effort!\n\n`;
          } else {
            comment += `‚ÑπÔ∏è **Usage unchanged**\n\n`;
          }
          
          // Add trend analysis if available
          if (fs.existsSync('trend_analysis.json')) {
            const trend = JSON.parse(fs.readFileSync('trend_analysis.json', 'utf8'));
            comment += `### üìà Usage Trend (Last 30 Days)\n\n`;
            comment += `- **Peak usage:** ${trend.peak_usage}\n`;
            comment += `- **Current trend:** ${trend.trend_direction} (${trend.trend_percentage}%)\n`;
            comment += `- **Projected removal:** ${trend.projected_removal_date}\n\n`;
          }
          
          // Show per-match details from by_pattern (flat list)
          const byPattern = report.by_pattern || {};
          const allMatches = Object.values(byPattern).flat();
          if (allMatches.length > 0) {
            comment += `### Usage Details\n\n`;
            for (const detail of allMatches.slice(0, 10)) {
              comment += `- \`${detail.file}:${detail.line}\` - \`${detail.pattern}\`\n`;
            }
            if (allMatches.length > 10) {
              comment += `\n... and ${allMatches.length - 10} more occurrences\n`;
            }
            
            comment += `\n### Migration Guide\n\n`;
            comment += `To migrate these usages, replace:\n`;
            comment += `- \`.temp_c()\` ‚Üí \`.temperature_c\`\n`;
            comment += `- \`.faults()\` ‚Üí \`.fault_flags\`\n`;
            comment += `- \`.wheel_angle_mdeg()\` ‚Üí \`.wheel_angle_deg\`\n`;
            comment += `- \`.wheel_speed_mrad_s()\` ‚Üí \`.wheel_speed_rad_s\`\n\n`;
            comment += `See [Migration Patterns](../docs/MIGRATION_PATTERNS.md) for detailed examples.\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });