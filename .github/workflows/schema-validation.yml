name: Schema Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'crates/schemas/**'
      - '.github/workflows/schema-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'crates/schemas/**'
      - '.github/workflows/schema-validation.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  validate-schemas:
    name: Validate Schemas
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for buf breaking change detection

    - name: Fetch origin/main for buf breaking
      if: github.event_name == 'pull_request'
      run: git fetch --no-tags --prune --depth=1 origin +refs/heads/main:refs/remotes/origin/main
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Install buf
      uses: bufbuild/buf-setup-action@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Install protoc
      uses: arduino/setup-protoc@v2
      with:
        version: '23.x'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Run buf compatibility checks
      run: |
        cd crates/schemas
        chmod +x scripts/check-compatibility.sh
        ./scripts/check-compatibility.sh
    
    - name: Build schemas crate
      run: cargo build -p racing-wheel-schemas --locked
    
    - name: Run schema validation tests
      run: cargo test -p racing-wheel-schemas --lib validation_tests --locked
    
    - name: Run all schema tests
      run: cargo test -p racing-wheel-schemas --locked -- --skip deprecated_tokens_compile_fail_tests

    - name: Run trybuild compile-fail guards
      run: cargo test -p racing-wheel-schemas --test trybuild_guards --locked

    - name: Upload trybuild WIP outputs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: trybuild-wip
        path: crates/schemas/wip/*.stderr
        if-no-files-found: ignore
    
    - name: Check formatting
      run: cargo fmt -p racing-wheel-schemas -- --check
    
    - name: Run clippy
      run: cargo clippy -p racing-wheel-schemas --locked -- -D warnings
    
    - name: Verify buf workspace builds
      run: |
        # Verify proto files are valid and buf workspace can be built
        # (Code generation via 'buf generate' requires BSR auth and is done locally)
        cd crates/schemas
        buf build

  test-json-schema:
    name: Test JSON Schema
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install ajv-cli for JSON Schema validation
      run: npm install -g ajv-cli
    
    - name: Validate JSON Schema syntax
      run: |
        ajv compile -s crates/schemas/schemas/profile.schema.json
    
    - name: Test JSON Schema with valid examples
      run: |
        # Create test data directory
        mkdir -p test-data
        
        # Valid profile example
        cat > test-data/valid-profile.json << 'EOF'
        {
          "schema": "wheel.profile/1",
          "scope": {
            "game": "iracing"
          },
          "base": {
            "ffbGain": 0.75,
            "dorDeg": 900,
            "torqueCapNm": 15.0,
            "filters": {
              "reconstruction": 4,
              "friction": 0.12,
              "damper": 0.18,
              "inertia": 0.08,
              "notchFilters": [],
              "slewRate": 0.85,
              "curvePoints": [
                {"input": 0.0, "output": 0.0},
                {"input": 1.0, "output": 1.0}
              ]
            }
          }
        }
        EOF
        
        # Test valid profile
        ajv validate -s crates/schemas/schemas/profile.schema.json -d test-data/valid-profile.json
        
        # Invalid profile example (missing required field)
        cat > test-data/invalid-profile.json << 'EOF'
        {
          "scope": {},
          "base": {
            "ffbGain": 0.75,
            "dorDeg": 900,
            "torqueCapNm": 15.0,
            "filters": {
              "reconstruction": 4,
              "friction": 0.12,
              "damper": 0.18,
              "inertia": 0.08,
              "notchFilters": [],
              "slewRate": 0.85,
              "curvePoints": [
                {"input": 0.0, "output": 0.0},
                {"input": 1.0, "output": 1.0}
              ]
            }
          }
        }
        EOF
        
        # Test invalid profile (should fail)
        if ajv validate -s crates/schemas/schemas/profile.schema.json -d test-data/invalid-profile.json; then
          echo "ERROR: Invalid profile should have failed validation"
          exit 1
        else
          echo "SUCCESS: Invalid profile correctly failed validation"
        fi
